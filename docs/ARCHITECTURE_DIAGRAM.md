# Neo4j Integration Architecture Diagram

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Opik Application                            â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    API Layer (REST)                       â”‚ â”‚
â”‚  â”‚          TraceResource, SpanResource, etc.               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                   Service Layer                           â”‚ â”‚
â”‚  â”‚   TraceService, SpanService, ProjectService, etc.        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                   DAO Layer (Interfaces)                  â”‚ â”‚
â”‚  â”‚      TraceDAO, SpanDAO, ProjectDAO, WorkspaceDAO         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Neo4j DAO Implementations                    â”‚ â”‚
â”‚  â”‚  TraceDAONeo4jImpl, SpanDAONeo4jImpl, etc.               â”‚ â”‚
â”‚  â”‚         (Cypher queries + reactive drivers)              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚          Neo4jTransactionTemplate                         â”‚ â”‚
â”‚  â”‚    (Manages reactive sessions and transactions)          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚            Neo4j Java Driver (Reactive)                   â”‚ â”‚
â”‚  â”‚         (Connection pool, session management)            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚       Neo4j Database    â”‚
              â”‚     (Graph Storage)     â”‚
              â”‚                         â”‚
              â”‚  Nodes: Trace, Span,   â”‚
              â”‚    Project, Workspace  â”‚
              â”‚                         â”‚
              â”‚  Relationships:        â”‚
              â”‚    HAS_TRACE, HAS_SPAN,â”‚
              â”‚    PARENT_OF, CONTAINS â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Model (Graph Schema)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Workspace  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ CONTAINS
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Project   â”‚â”€â”€HAS_TRACEâ”€â”€â–¶â”‚  Trace   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â”‚                          â”‚
       â”‚ HAS_SPAN_IN_PROJECT     â”‚ HAS_SPAN
       â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Span     â”‚â—€â”€â”€PARENT_OFâ”€â”€â”‚   Span   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                          â”‚
       â”‚ HAS_FEEDBACK_SCORE      â”‚ HAS_COMMENT
       â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚FeedbackScoreâ”‚              â”‚ Comment  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Interaction Flow

### Creating a Trace with Spans

```
Client                API              Service           DAO              Neo4j
  â”‚                    â”‚                 â”‚                â”‚                 â”‚
  â”‚ POST /traces       â”‚                 â”‚                â”‚                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                 â”‚                â”‚                 â”‚
  â”‚                    â”‚ create(trace)   â”‚                â”‚                 â”‚
  â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                 â”‚
  â”‚                    â”‚                 â”‚ insert(trace)  â”‚                 â”‚
  â”‚                    â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                 â”‚
  â”‚                    â”‚                 â”‚                â”‚ MATCH (p:Proj) â”‚
  â”‚                    â”‚                 â”‚                â”‚ CREATE (t:Tr)  â”‚
  â”‚                    â”‚                 â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚                    â”‚                 â”‚                â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                    â”‚                 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   trace.id     â”‚
  â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚                 â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚                â”‚                 â”‚
  â”‚   201 Created      â”‚                 â”‚                â”‚                 â”‚
  â”‚                    â”‚                 â”‚                â”‚                 â”‚
  â”‚ POST /spans (batch)â”‚                 â”‚                â”‚                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                 â”‚                â”‚                 â”‚
  â”‚                    â”‚ batchInsert()   â”‚                â”‚                 â”‚
  â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                 â”‚
  â”‚                    â”‚                 â”‚ batchInsert()  â”‚                 â”‚
  â”‚                    â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                 â”‚
  â”‚                    â”‚                 â”‚                â”‚ UNWIND $spans  â”‚
  â”‚                    â”‚                 â”‚                â”‚ CREATE (s:Span)â”‚
  â”‚                    â”‚                 â”‚                â”‚ CREATE rels    â”‚
  â”‚                    â”‚                 â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚                    â”‚                 â”‚                â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                    â”‚                 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   count        â”‚
  â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚                 â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚                â”‚                 â”‚
  â”‚   201 Created      â”‚                 â”‚                â”‚                 â”‚
```

### Querying Trace Details

```
Client                API              Service           DAO              Neo4j
  â”‚                    â”‚                 â”‚                â”‚                 â”‚
  â”‚ GET /traces/{id}   â”‚                 â”‚                â”‚                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                 â”‚                â”‚                 â”‚
  â”‚                    â”‚ getDetails(id)  â”‚                â”‚                 â”‚
  â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                 â”‚
  â”‚                    â”‚                 â”‚ getDetails(id) â”‚                 â”‚
  â”‚                    â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                 â”‚
  â”‚                    â”‚                 â”‚                â”‚ MATCH (t:Trace)â”‚
  â”‚                    â”‚                 â”‚                â”‚ -[:HAS_SPAN]-> â”‚
  â”‚                    â”‚                 â”‚                â”‚ (s:Span)       â”‚
  â”‚                    â”‚                 â”‚                â”‚ RETURN t, s    â”‚
  â”‚                    â”‚                 â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚                    â”‚                 â”‚                â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                    â”‚                 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ trace + spans  â”‚
  â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚                 â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚                â”‚                 â”‚
  â”‚   200 OK + JSON    â”‚                 â”‚                â”‚                 â”‚
```

## Transaction Management Flow

```
Application Code          Neo4jTransactionTemplate      Neo4j Driver
      â”‚                           â”‚                          â”‚
      â”‚ writeTransaction(work)    â”‚                          â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                          â”‚
      â”‚                           â”‚ session.beginTx()        â”‚
      â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
      â”‚                           â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚                           â”‚      ReactiveTransaction â”‚
      â”‚                           â”‚                          â”‚
      â”‚                           â”‚ execute work(tx)         â”‚
      â”‚                           â”‚   â”‚                      â”‚
      â”‚                           â”‚   â”‚ tx.run(cypher)       â”‚
      â”‚                           â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
      â”‚                           â”‚   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚                           â”‚   â”‚     Result           â”‚
      â”‚                           â”‚   â”‚                      â”‚
      â”‚                           â”‚ tx.commit()              â”‚
      â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
      â”‚                           â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚                           â”‚ session.close()          â”‚
      â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
      â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
      â”‚      Mono<Result>         â”‚                          â”‚
```

## Dependency Injection Flow (Guice)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 OpikApplication                         â”‚
â”‚                                                         â”‚
â”‚  Guice.createInjector(                                 â”‚
â”‚    new DatabaseGraphModule(),   â—€â”€â”€ Neo4j setup        â”‚
â”‚    new ServiceModule(),                                â”‚
â”‚    new ResourceModule()                                â”‚
â”‚  )                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ provides
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           DatabaseGraphModule                           â”‚
â”‚                                                         â”‚
â”‚  @Provides Driver provideNeo4jDriver(config)           â”‚
â”‚  @Provides Mono<ReactiveSession> provideSession(drv)   â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ injected into
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Neo4jTransactionTemplate                         â”‚
â”‚  (Singleton, injected with Mono<ReactiveSession>)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ injected into
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DAO Implementations                        â”‚
â”‚  TraceDAONeo4jImpl(Neo4jTransactionTemplate)           â”‚
â”‚  SpanDAONeo4jImpl(Neo4jTransactionTemplate)            â”‚
â”‚  ProjectDAONeo4jImpl(Neo4jTransactionTemplate)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Reactive Data Flow (Project Reactor)

```
Client Request
      â”‚
      â–¼
[API Layer: returns Mono/Flux]
      â”‚
      â–¼
[Service Layer: chains reactive operations]
      â”‚
      â–¼
[DAO Layer: returns Mono/Flux]
      â”‚
      â–¼
[Neo4jTransactionTemplate]
      â”‚
      â”œâ”€ Mono.from(session)
      â”‚     â”‚
      â”‚     â–¼
      â”‚  session.beginTransaction()
      â”‚     â”‚
      â”‚     â–¼
      â”‚  tx.run(cypher, params)
      â”‚     â”‚
      â”‚     â–¼
      â”‚  Flux.from(result.records())
      â”‚     â”‚
      â”‚     â–¼
      â”‚  .map(record -> mapToEntity(record))
      â”‚     â”‚
      â”‚     â–¼
      â”‚  tx.commit()
      â”‚     â”‚
      â”‚     â–¼
      â”‚  session.close()
      â”‚
      â–¼
[Returns Mono<Entity> or Flux<Entity>]
      â”‚
      â–¼
Back to Client (async, non-blocking)
```

## Docker Compose Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Docker Compose Stack                 â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    Neo4j     â”‚  â”‚    Redis     â”‚  â”‚  MinIO   â”‚ â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚          â”‚ â”‚
â”‚  â”‚ Port: 7474   â”‚  â”‚ Port: 6379   â”‚  â”‚Port: 9090â”‚ â”‚
â”‚  â”‚      7687    â”‚  â”‚              â”‚  â”‚     9000 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â–²                 â–²                 â–²      â”‚
â”‚         â”‚                 â”‚                 â”‚      â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                           â”‚                        â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚                    â”‚   Backend   â”‚                 â”‚
â”‚                    â”‚   (Opik)    â”‚                 â”‚
â”‚                    â”‚  Port: 8080 â”‚                 â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## File Structure Overview

```
opik-neo4j/
â”œâ”€â”€ start-neo4j.sh                    # ğŸš€ Quick start script
â”œâ”€â”€ README_NEO4J.md                   # ğŸ“– Main documentation
â”œâ”€â”€ NEO4J_INTEGRATION.md              # ğŸ—ï¸ Architecture guide
â”œâ”€â”€ NEO4J_ROADMAP.md                  # ğŸ—ºï¸ Implementation plan
â”œâ”€â”€ IMPLEMENTATION_SUMMARY.md         # âœ… What's complete
â”œâ”€â”€ CHECKLIST.md                      # â˜‘ï¸ Getting started guide
â”œâ”€â”€ ARCHITECTURE_DIAGRAM.md           # ğŸ“Š This file
â”‚
â””â”€â”€ opik/
    â”œâ”€â”€ apps/opik-backend/
    â”‚   â”œâ”€â”€ pom.xml                   # âš™ï¸ Neo4j dependencies
    â”‚   â”œâ”€â”€ config.yml                # âš™ï¸ Neo4j configuration
    â”‚   â”‚
    â”‚   â”œâ”€â”€ src/main/java/.../
    â”‚   â”‚   â”œâ”€â”€ infrastructure/
    â”‚   â”‚   â”‚   â”œâ”€â”€ Neo4jConfiguration.java
    â”‚   â”‚   â”‚   â”œâ”€â”€ db/
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DatabaseGraphModule.java
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Neo4jTransactionTemplate.java
    â”‚   â”‚   â”‚   â””â”€â”€ health/
    â”‚   â”‚   â”‚       â””â”€â”€ Neo4jHealthCheck.java
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€â”€ domain/
    â”‚   â”‚       â”œâ”€â”€ TraceDAONeo4jImpl.java      # âœ… Complete
    â”‚   â”‚       â”œâ”€â”€ SpanDAONeo4jImpl.java       # âœ… Complete
    â”‚   â”‚       â””â”€â”€ ProjectDAONeo4jImpl.java    # âœ… Complete
    â”‚   â”‚
    â”‚   â”œâ”€â”€ src/main/resources/
    â”‚   â”‚   â””â”€â”€ neo4j/
    â”‚   â”‚       â””â”€â”€ schema.cypher       # ğŸ“Š Graph schema
    â”‚   â”‚
    â”‚   â””â”€â”€ src/test/java/.../
    â”‚       â””â”€â”€ infrastructure/db/
    â”‚           â”œâ”€â”€ Neo4jIntegrationTest.java   # ğŸ§ª Tests
    â”‚           â””â”€â”€ Neo4jPerformanceTest.java   # ğŸ“ˆ Benchmarks
    â”‚
    â””â”€â”€ deployment/docker-compose/
        â””â”€â”€ docker-compose.yaml        # ğŸ³ Neo4j service
```

## Key Design Patterns

### 1. Repository Pattern
```
Interface (TraceDAO)
    â†“
Implementation (TraceDAONeo4jImpl)
    â†“
Database (Neo4j)
```

### 2. Reactive Streams Pattern
```
Mono<T>  - Single value or empty (like Optional)
Flux<T>  - Multiple values (like Stream)

Operations:
- map(): Transform values
- flatMap(): Async transformation
- filter(): Conditional logic
- doOnNext(): Side effects
- subscribe(): Terminal operation
```

### 3. Template Method Pattern
```
Neo4jTransactionTemplate provides:
- writeTransaction(work)
- readTransaction(work)
- writeTransactionMany(work)
- readTransactionMany(work)

Handles:
- Session management
- Transaction lifecycle
- Error handling
- Resource cleanup
```

## Performance Considerations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Performance Layers                      â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Application Layer (Connection Pooling)         â”‚  â”‚
â”‚  â”‚  - Max pool size: 50 connections                â”‚  â”‚
â”‚  â”‚  - Timeout: 60 seconds                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â†•                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Neo4j Constraints & Indexes                    â”‚  â”‚
â”‚  â”‚  - Unique constraints on IDs                    â”‚  â”‚
â”‚  â”‚  - Indexes on: startTime, workspaceId, etc.    â”‚  â”‚
â”‚  â”‚  - Full-text search on: input, output          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â†•                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Query Optimization                             â”‚  â”‚
â”‚  â”‚  - Batch inserts (UNWIND)                       â”‚  â”‚
â”‚  â”‚  - Index hints (USING INDEX)                    â”‚  â”‚
â”‚  â”‚  - Relationship direction                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â†•                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Neo4j Configuration                            â”‚  â”‚
â”‚  â”‚  - Heap: 1G (docker-compose)                    â”‚  â”‚
â”‚  â”‚  - Page cache: Auto                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Testing Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Testing Pyramid                       â”‚
â”‚                                                    â”‚
â”‚                   â•±â•²                              â”‚
â”‚                  â•±  â•²  E2E Tests                  â”‚
â”‚                 â•±    â•² (Manual + Automated)       â”‚
â”‚                â•±â”€â”€â”€â”€â”€â”€â•²                           â”‚
â”‚               â•±        â•²                          â”‚
â”‚              â•± Integr.  â•² Integration Tests       â”‚
â”‚             â•±  Tests     â•² (Testcontainers)       â”‚
â”‚            â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²                       â”‚
â”‚           â•±                â•²                      â”‚
â”‚          â•±   Unit Tests     â•² Unit Tests          â”‚
â”‚         â•±    (80% of tests)  â•² (JUnit + Mockito)  â”‚
â”‚        â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²                   â”‚
â”‚                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

This architecture provides:
- âœ… Clear separation of concerns
- âœ… Reactive, non-blocking operations
- âœ… Proper transaction management
- âœ… Testable design
- âœ… Scalable infrastructure
- âœ… Production-ready patterns

